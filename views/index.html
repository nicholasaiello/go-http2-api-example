{{ define "views/index.html"}}
<!DOCTYPE html>
<html lang="en">
<head>
  {{ template "views/_head.html" .}}
</head>
<body>
  {{ template "views/_body.html" .}}
  {{ template "views/_body_script.html" .}}
  <script>  
	function getAccountsAndBoundedPortfolio() {
		fetchAccounts()
			.then(data => {
				app.accounts = data || [];

				setAccountsDropdown('accounts', app.accounts);

				return fetchPortfolio(app.accounts[0], { chunk: chunkSize, limit: initialLimit });
			})
			.then(data => {
				const { positionDetails, totalPositionCount } = data;

				app.portfolio = data;

				appendPositionsRows(positionDetails, false);

				if (pushMode === PushModes.ON) {
					console.log('[%s] there are %s positions remaining... Making one more request', pushMode, totalPositionCount - initialLimit);

					const newLimit = totalPositionCount - initialLimit;

					if (newLimit <= 0) {
						return Promise.resolve([]);
					}

					return fetchPortfolio(app.accounts[0], { start: initialLimit, limit: newLimit })
						.then(({ positionDetails, totalPositionCount }) => {
							appendPositionsRows(positionDetails);
						});
				}

				const chunks = Math.ceil((totalPositionCount - initialLimit) / chunkSize);

				console.log('[%s] there are %s positions... Making %s requests', pushMode, totalPositionCount, chunks);

				return Promise.all(
					Array(chunks).fill(0).map((_, i) => (
						fetchPortfolio(app.accounts[0], { start: initialLimit + (i * chunkSize), limit: chunkSize })
					))
				).then(results => {
					const allPositions = results.flatMap(({ positionDetails }) => positionDetails);

					appendPositionsRows(allPositions);
				});
			});
		}

	function getAccountsAndSelectedPortfolio() {
		fetchAccounts(includePortfolio ? '?includePortfolio=1' : '')
			.then(data => {
				app.accounts = data || [];

				document.getElementById('accounts').innerHTML = '<select id="accountsList">' + 
					app.accounts.map(({ accountId, accountShortName }) => (`<option value="${accountId}">${accountShortName}</option>`)).join('') + 
				'</select>';

				return fetchPortfolio(app.accounts[0]);
			})
			.then(data => {
				const { positionDetails, totalPositionCount } = data;

				app.portfolio = data;

				appendPositionsRows(positionDetails, false);
			});
	}

	getAccountsAndSelectedPortfolio();
  </script>
</body>
</html>
{{ end }}
